{% extends 'principal/base.html' %}
{% block title %}Painel{% endblock %}

{% block content %}


  <style>
    body {
      background-color: #f4f6f9;
      font-family: "Segoe UI", Roboto, sans-serif;
    }


    /* Input de produto */
    .product-input {
      font-size: 1.5rem;
      padding: 18px;
      border-radius: 12px;
      border: 2px solid #e0e3e7;
      transition: all 0.3s ease;
    }

    .product-input:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 4px rgba(13,110,253,0.15);
    }

    /* Card */
    .card {
      border-radius: 14px;
      border: none;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      background: #fff;
    }

    /* Tabela */
    .table thead th {
      background: #0d6efd;
      color: white;
      font-size: 1rem;
      text-align: center;
      border: none;
    }

    .table tbody tr:hover {
      background: #f8f9fa;
    }

    .table td {
      font-size: 1.05rem;
      text-align: center;
      vertical-align: middle;
    }

    .qtd-input {
      width: 70px;
      text-align: center;
    }

    /* Resumo */
    .summary p {
      font-size: 1.1rem;
      margin: 6px 0;
    }

    .total-highlight {
      font-size: 2.5rem;
      font-weight: 700;
      color: #198754;
      text-align: right;
      letter-spacing: -1px;
    }

    hr {
      opacity: 0.15;
    }

    /* Botões */
    .actions button {
      width: 100%;
      padding: 18px;
      font-size: 1.2rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .actions button i {
      margin-right: 8px;
    }

    .actions .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    @media (max-width: 992px) {
      .total-highlight {
        text-align: center;
      }
    }
  </style>
</head>
<body>


  <div class="container-fluid my-4">
    <div class="row g-4">

      <!-- Coluna Esquerda -->
      <div class="col-lg-8">
        <br>
        <!-- Input Produto -->
        <div class="mb-4">
          <input type="text" class="form-control product-input" placeholder="Digite ou escaneie o código do produto">
        </div>

        <!-- Lista de Produtos -->
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0" id="tabelaProdutos">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Produto</th>
                    <th>Preço Unit.</th>
                    <th>Total</th>
                    <th>Qtd</th>
                  </tr>
                </thead>
                <tbody>
                 
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      <!-- Coluna Direita -->
      <div class="col-lg-4">

        <!-- Botões -->
        <div class="actions mt-4">
          
          <!-- Botão para abrir modal -->
          <button class="btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#descontoModal">
            <i class="fa-solid fa-tags"></i> Aplicar Desconto
          </button>

          <!-- Botão -->
          <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#finalizarVendaModal">
            <i class="fa-solid fa-check"></i> Finalizar Venda
          </button>
          
          <!-- Botão que abre o modal -->
          <button class="btn btn-danger mb-3" data-bs-toggle="modal" data-bs-target="#cancelarModal">
            <i class="fa-solid fa-ban"></i> Cancelar
          </button>
        </div>

        <div class="card">
          <div class="card-body summary">
            <h5 class="mb-3"><i class="fa-solid fa-receipt"></i> Resumo da Compra</h5>
            <p><strong>Subtotal:</strong> <span id="subtotalCompra">R$ 0,00</span></p>
            
            <hr>
            <p class="total-highlight">TOTAL: <span id="totalCompra">R$ 0,00</span></p>
            <hr>
            <p><strong>Forma de Pagamento:</strong> Dinheiro</p>
            <p><strong>Recebido:</strong> R$ 0,00</p>
            <p><strong>Troco:</strong> R$ 0,00</p>
          </div>
        </div>

        
      </div>

    </div>
  </div>



<!-- Modal -->
<div class="modal fade" id="finalizarVendaModal" tabindex="-1" aria-labelledby="finalizarVendaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" action="{% url 'finalizar_venda' %}" id="formFinalizarVenda">
    {% csrf_token %}
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="finalizarVendaLabel">Finalizar Venda</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        
        <!-- Escolha do tipo de pagamento -->
        <div class="mb-3">
          <label class="form-label fw-bold">Tipo de Pagamento:</label>
          <select class="form-select" id="tipoPagamento">
            <option value="" selected disabled>Selecione...</option>
            <option value="unico">Pagamento Único</option>
            <option value="combinado">Pagamento Combinado</option>
          </select>
        </div>

        <!-- PAGAMENTO ÚNICO -->
        <div id="pagamentoUnico" class="d-none">
          <label class="form-label fw-bold">Forma de Pagamento:</label>
          <select class="form-select mb-3" id="formaUnico">
            <option value="" selected disabled>Selecione...</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao">Cartão</option>
            <option value="pix">PIX</option>
          </select>

          <!-- Campo Dinheiro -->
          <div id="campoDinheiro" class="d-none">
            <label class="form-label">Valor entregue pelo cliente:</label>
            <input type="number" class="form-control mb-2" id="valorEntregue" placeholder="Ex: 100.00">
            <p><strong>Total da venda:</strong> R$ <span id="totalVenda">80.00</span></p>
            <p><strong>Troco:</strong> R$ <span id="troco">0.00</span></p>
          </div>
        </div>

        <!-- PAGAMENTO COMBINADO -->
        <div id="pagamentoCombinado" class="d-none">
          <label class="form-label fw-bold">Combinação:</label>
          <select class="form-select mb-3" id="formaCombinada">
            <option value="" selected disabled>Selecione...</option>
            <option value="cartao_dinheiro">Cartão + Dinheiro</option>
            <option value="pix_dinheiro">PIX + Dinheiro</option>
            <option value="cartao_pix">Cartão + PIX</option>
          </select>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
      </div>

      <input type="hidden" name="produtos_json" id="produtos_json">
      <input type="hidden" name="desconto" id="descontoFinal">
      <input type="hidden" name="forma_pagamento" id="forma_pagamento_final">
      <input type="hidden" name="valor_entregue" id="valor_entregue_final">
      <input type="hidden" name="troco" id="troco_final">
      <input type="hidden" name="subtotal" id="subtotal_final">
      <input type="hidden" name="total" id="total_final">
    </div>
    </form>
  </div>
</div>




<!-- Modal -->
<div class="modal fade" id="cancelarModal" tabindex="-1" aria-labelledby="cancelarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <!-- Cabeçalho -->
      <div class="modal-header bg-danger text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="cancelarModalLabel">
          <i class="fa-solid fa-ban me-2"></i> Cancelamento de Produto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <!-- Corpo -->
      <div class="modal-body p-4">
        <p class="text-muted mb-3">
          Digite o <strong>código do produto</strong> que deseja cancelar ou escolha cancelar toda a compra.
        </p>
        <div class="mb-3">
          <label for="codigoCancelamento" class="form-label fw-semibold">Código do produto</label>
          <input type="text" class="form-control form-control-lg rounded-3 shadow-sm" id="codigoCancelamento" placeholder="Ex: 1002">
        </div>
      </div>

      <!-- Rodapé -->
      <div class="modal-footer border-0 d-flex flex-column flex-sm-row justify-content-between gap-2 px-4 pb-4">
        <button type="button" class="btn btn-danger w-100 fw-semibold py-2">
          <i class="fa-solid fa-trash me-1"></i> Cancelar Produto
        </button>
        <button type="button" class="btn btn-dark w-100 fw-semibold py-2">
          <i class="fa-solid fa-ban me-1"></i> Cancelar Tudo
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal de Desconto -->
<div class="modal fade" id="descontoModal" tabindex="-1" aria-labelledby="descontoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                
                <div class="modal-header">
                  <h5 class="modal-title" id="descontoModalLabel" style="white-space: nowrap;">
                    <i class="fa-solid fa-tags me-2"></i> Aplicar Desconto
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                  <label for="descontoPercentual" class="form-label">Informe o desconto (%)</label>
                  <input type="number" class="form-control" id="descontoPercentual" min="0" max="100" value="0">
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-warning" id="aplicarDesconto">Aplicar</button>
                </div>

              </div>
            </div>
</div>

<script>
document.getElementById("formFinalizarVenda").addEventListener("submit", function(e) {
    // pegar produtos da tabela
    const produtos = [];
    document.querySelectorAll("#tabelaProdutos tbody tr").forEach(tr => {
        const codigo = tr.children[0].textContent.trim();
        const nome = tr.children[1].textContent.trim();
        const preco = parseFloat(tr.children[2].textContent.replace("R$", "").replace(",", ".").trim());
        const subtotal = parseFloat(tr.children[3].textContent.replace("R$", "").replace(",", ".").trim());
        const qtd = parseInt(tr.querySelector(".qtd-input").value);

        produtos.push({codigo, nome, preco, qtd, subtotal});
    });

    // colocar no input hidden
    document.getElementById("produtos_json").value = JSON.stringify(produtos);

    // desconto
    const descontoEl = document.getElementById("descontoPercentual");
    document.getElementById("descontoFinal").value = descontoEl ? parseFloat(descontoEl.value) || 0 : 0;

    // forma de pagamento
    const forma = formaUnico.value || document.getElementById("formaCombinada").value;
    document.getElementById("forma_pagamento_final").value = forma;

    // dinheiro entregue e troco
    document.getElementById("valor_entregue_final").value = valorEntregue.value || 0;
    document.getElementById("troco_final").value = troco.innerText.replace(",", ".").trim();

    // subtotal e total
    document.getElementById("subtotal_final").value = document.getElementById("subtotalCompra").textContent.replace("R$", "").replace(",", ".").trim();
    document.getElementById("total_final").value = document.getElementById("totalCompra").textContent.replace("R$", "").replace(",", ".").trim();
});
</script>

<!-- desconto -->
<script>
          const btnDesconto = document.getElementById("aplicarDesconto");
          const inputDesconto = document.getElementById("descontoPercentual");

          // ação do botão aplicar
          function aplicarDesconto() {
              const desconto = parseFloat(inputDesconto.value) || 0;

              // pega subtotal
              const subtotalEl = document.getElementById("subtotalCompra");
              let subtotal = parseFloat(subtotalEl.textContent.replace("R$", "").replace(",", ".").trim());

              // calcula valor do desconto e total
              const valorDesconto = subtotal * (desconto / 100);
              const total = subtotal - valorDesconto;

              // atualiza valores no resumo
              subtotalEl.textContent = "R$ " + subtotal.toFixed(2);
              document.getElementById("totalCompra").textContent = "R$ " + total.toFixed(2);

              // exibe desconto aplicado
              let descontoElement = document.getElementById("descontoResumo");
              if (!descontoElement) {
                  descontoElement = document.createElement("p");
                  descontoElement.id = "descontoResumo";
                  document.querySelector(".summary").insertBefore(descontoElement, document.querySelector(".summary hr"));
              }
              descontoElement.innerHTML = `<strong>Descontos:</strong> R$ ${valorDesconto.toFixed(2)}`;

              // fecha modal
              document.querySelector('#descontoModal .btn-close').click();
          }

          // clique no botão
          btnDesconto.addEventListener("click", aplicarDesconto);

          // Enter no input
          inputDesconto.addEventListener("keydown", function(e) {
              if (e.key === "Enter") {
                  e.preventDefault(); // evita submit padrão
                  aplicarDesconto();
              }
          });
</script>          

<!-- finalização de venda -->
<script>
  function getTotalVenda() {
    let totalText = document.getElementById("totalCompra").textContent
      .replace("R$", "")
      .replace(",", ".")
      .trim();
    return parseFloat(totalText) || 0;
  }

  // Exibir no modal o valor atual da venda
  document.getElementById("finalizarVendaModal").addEventListener("show.bs.modal", () => {
    const totalVenda = getTotalVenda();
    document.getElementById("totalVenda").innerText = totalVenda.toFixed(2);
  });

  const tipoPagamento = document.getElementById("tipoPagamento");
  const pagamentoUnico = document.getElementById("pagamentoUnico");
  const pagamentoCombinado = document.getElementById("pagamentoCombinado");

  const formaUnico = document.getElementById("formaUnico");
  const campoDinheiro = document.getElementById("campoDinheiro");
  const valorEntregue = document.getElementById("valorEntregue");
  const troco = document.getElementById("troco");

  // Mostrar se é único ou combinado
  tipoPagamento.addEventListener("change", () => {
    pagamentoUnico.classList.add("d-none");
    pagamentoCombinado.classList.add("d-none");
    if (tipoPagamento.value === "unico") {
      pagamentoUnico.classList.remove("d-none");
    } else if (tipoPagamento.value === "combinado") {
      pagamentoCombinado.classList.remove("d-none");
    }
  });

  // Mostrar campo dinheiro no pagamento único
  formaUnico.addEventListener("change", () => {
    campoDinheiro.classList.add("d-none");
    if (formaUnico.value === "dinheiro") {
      campoDinheiro.classList.remove("d-none");
    }
  });

  // Calcular troco
  valorEntregue.addEventListener("input", () => {
    const entregue = parseFloat(valorEntregue.value) || 0;
    const totalVenda = getTotalVenda(); // sempre pegar o total atualizado
    const trocoCalculado = entregue - totalVenda;
    troco.innerText = trocoCalculado >= 0 ? trocoCalculado.toFixed(2) : "0.00";
  });
</script>

<!-- adicionar produto novo -->
<script>
function atualizarResumo() {
    let subtotal = 0;

    document.querySelectorAll("#tabelaProdutos tbody .subtotal").forEach(function(cell) {
        let valor = cell.textContent.replace("R$", "").replace(",", ".").trim();
        subtotal += parseFloat(valor) || 0;
    });

    // Atualiza os campos do resumo
    document.querySelector("#subtotalCompra").textContent = "R$ " + subtotal.toFixed(2);
    document.querySelector("#totalCompra").textContent = "R$ " + subtotal.toFixed(2);
}

// Quando mudar a quantidade
document.addEventListener("input", function(e) {
    if (e.target.classList.contains("qtd-input")) {
        let qtd = parseInt(e.target.value) || 1;
        let preco = parseFloat(e.target.getAttribute("data-preco"));
        let subtotal = qtd * preco;

        let subtotalCell = e.target.closest("tr").querySelector(".subtotal");
        subtotalCell.textContent = "R$ " + subtotal.toFixed(2);

        atualizarResumo();
    }
});

// Quando adicionar um produto novo
document.querySelector(".product-input").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        let codigo = this.value.trim();

        if (codigo) {
            fetch(`/painel/buscar-produto/?codigo=${codigo}`)
            .then(response => response.json())
            .then(data => {
                if (!data.erro) {
                    let tabela = document.querySelector("#tabelaProdutos tbody");
                    let novaLinha = document.createElement("tr");

                    novaLinha.innerHTML = `
                        <td>${data.codigo}</td>
                        <td>${data.nome}</td>
                        <td>R$ ${data.preco.toFixed(2)}</td>
                        <td class="subtotal">R$ ${data.preco.toFixed(2)}</td>
                        <td><input type="number" class="form-control qtd-input" value="1" min="1" data-preco="${data.preco}"></td>
                    `;

                    tabela.appendChild(novaLinha);
                    atualizarResumo();
                }
                this.value = "";
            });
        }
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endblock %}
